{% extends "dashboard/base.html" %}
{% load humanize %}

{% block content %}

<h4 class="mb-3 fw-bold">Dashboard Ringkasan SP2DK</h4>

<!-- FILTER -->
<form method="get" class="card-box mb-3">

<div class="row">

<div class="col-md-2">
<label>Tahun SP2DK</label>
<select name="tahun_sp2dk" class="form-control" onchange="this.form.submit()">
<option value="All">All</option>
{% for t in tahun_list %}
<option value="{{ t }}" {% if selected_tahun_sp2dk == t %}selected{% endif %}>{{ t }}</option>
{% endfor %}
</select>
</div>

<div class="col-md-2">
<label>Tahun LHP2DK</label>
<select name="tahun_lhp2dk" class="form-control" onchange="this.form.submit()">
<option value="All">All</option>
{% for t in tahun_list %}
<option value="{{ t }}" {% if selected_tahun_lhp2dk == t %}selected{% endif %}>{{ t }}</option>
{% endfor %}
</select>
</div>

<div class="col-md-2">
<label>Seksi</label>
<select name="seksi" class="form-control" onchange="this.form.submit()">
<option value="All">All</option>
{% for s in seksi_list %}
<option value="{{ s }}" {% if selected_seksi == s %}selected{% endif %}>{{ s }}</option>
{% endfor %}
</select>
</div>

<div class="col-md-2">
<label>AR</label>
<select name="ar" class="form-control" onchange="this.form.submit()">
<option value="All">All</option>
{% for a in ar_list %}
<option value="{{ a }}" {% if selected_ar == a %}selected{% endif %}>{{ a }}</option>
{% endfor %}
</select>
</div>

<div class="col-md-4">
<label>Kesimpulan LHP2DK</label>
<select name="kesimpulan" class="form-control" onchange="this.form.submit()">
<option value="All">All</option>
<option value="selesai">Selesai</option>
<option value="pemeriksaan">Usul Pemeriksaan</option>
<option value="pengawasan">Dalam Pengawasan</option>
</select>
</div>

</div>

</form>

<!-- TABEL -->
<div class="card-box">
<table class="table table-bordered">
<thead class="table-header">
<tr>
<th>Unit</th>
<th>SP2DK</th>
<th>LHP2DK</th>
<th>Outstanding</th>
<th>Potensi</th>
<th>Realisasi</th>
<th>Success Rate</th>
</tr>
</thead>

<tbody>

{% for s in seksi_summary %}
<tr style="background:#e8eefc; font-weight:bold">
<td onclick="toggle('{{ s.unit_kerja|slugify }}')" style="cursor:pointer">
+ {{ s.unit_kerja }}
</td>
<td>{{ s.sp2dk|default:0 }}</td>
<td>{{ s.lhp2dk|default:0 }}</td>
<td>{{ s.outstanding|default:0 }}</td>
<td>Rp {{ s.potensi|floatformat:0|intcomma }}</td>
<td>Rp {{ s.realisasi|floatformat:0|intcomma }}</td>

<td class="
{% if s.success_rate < 50 %}low
{% elif s.success_rate < 80 %}mid
{% else %}high
{% endif %}
">
{{ s.success_rate }}%
</td>
</tr>

{% for d in ar_detail %}
{% if d.unit_kerja == s.unit_kerja %}
<tr class="{{ s.unit_kerja|slugify }}" style="display:none">
<td>&nbsp;&nbsp;&nbsp;â†’ {{ d.petugas_pengawasan }}</td>
<td>{{ d.sp2dk }}</td>
<td>{{ d.lhp2dk }}</td>
<td>{{ d.outstanding }}</td>
<td>Rp {{ d.potensi|floatformat:0|intcomma }}</td>
<td>Rp {{ d.realisasi|floatformat:0|intcomma }}</td>
<td></td>
</tr>
{% endif %}
{% endfor %}

{% endfor %}

</tbody>
</table>
</div>

<br>

<div class="row">

<div class="col-md-6">
<div class="card-box">
<h6 class="text-center">KESIMPULAN LHP2DK</h6>
<canvas id="pie"></canvas>
</div>
</div>

<div class="col-md-6">
<div class="card-box">
<h6 class="text-center">SP2DK TERBIT PER BULAN</h6>
<canvas id="bar"></canvas>
</div>
</div>

</div>

<script>
function toggle(cls){
  const rows = document.getElementsByClassName(cls);
  for(let i=0;i<rows.length;i++){
    rows[i].style.display = rows[i].style.display === "none" ? "" : "none";
  }
}

new Chart(document.getElementById("pie"),{
  type:'pie',
  data:{
    labels: {{ pie_labels|safe }},
    datasets:[{ data: {{ pie_values|safe }} }]
  }
});

new Chart(document.getElementById("bar"),{
  type:'bar',
  data:{
    labels: {{ bar_labels|safe }},
    datasets:[{ data: {{ bar_values|safe }} }]
  }
});
</script>

<style>
.low{color:red;font-weight:bold;}
.mid{color:orange;font-weight:bold;}
.high{color:green;font-weight:bold;}
</style>

{% endblock %}
