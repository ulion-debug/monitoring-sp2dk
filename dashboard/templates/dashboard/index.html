{% extends "dashboard/base.html" %}
{% load humanize %}
{% block content %}

<h4 class="mb-3 fw-bold">Dashboard Ringkasan SP2DK</h4>

<form method="get" class="card-box mb-3">

<div class="row">

<div class="col-md-2">
<label>Tahun SP2DK</label>
<select name="tahun_sp2dk" class="form-control" onchange="this.form.submit()">
<option value="All">All</option>
{% for t in tahun_list %}
<option value="{{ t }}" {% if selected_tahun_sp2dk == t %}selected{% endif %}>{{ t }}</option>
{% endfor %}
</select>
</div>

<div class="col-md-2">
<label>Seksi</label>
<select name="seksi" class="form-control" onchange="this.form.submit()">
<option value="All">All</option>
{% for s in seksi_list %}
<option value="{{ s }}" {% if selected_seksi == s %}selected{% endif %}>{{ s }}</option>
{% endfor %}
</select>
</div>

<div class="col-md-2">
<label>AR</label>
<select name="ar" class="form-control" onchange="this.form.submit()">
<option value="All">All</option>
{% for a in ar_list %}
<option value="{{ a }}" {% if selected_ar == a %}selected{% endif %}>{{ a }}</option>
{% endfor %}
</select>
</div>

<div class="col-md-2">
<label>Kesimpulan</label>
<select name="kesimpulan" class="form-control" onchange="this.form.submit()">
    <option value="All">All</option>
    {% for k in pie_labels %}
        <option value="{{ k }}" {% if selected_kesimpulan == k %}selected{% endif %}>{{ k }}</option>
    {% endfor %}
</select>
</div>

</div>

</form>

<div class="card-box">

<table class="table table-bordered">
<thead class="table-header">
<tr>
<th>Unit</th>
<th>DPP</th>
<th>SP2DK</th>
<th>LHP2DK</th>
<th>Outstanding</th>
<th>Potensi</th>
<th>Realisasi</th>
<th>Success Rate</th>
</tr>
</thead>

<tbody>

{% for s in seksi_summary %}
<tr style="background:#e8eefc; font-weight:bold">
<td onclick="toggle('{{ s.unit_kerja }}')" style="cursor:pointer">+ {{ s.unit_kerja }}</td>
<td>{{ s.sp2dk|default:0 }}</td>
<td>{{ s.sp2dk|default:0 }}</td>
<td>{{ s.lhp2dk|default:0 }}</td>
<td>{{ s.outstanding|default:0 }}</td>
<td>Rp {{ s.potensi|floatformat:0|intcomma }}</td>
<td>Rp {{ s.realisasi|floatformat:0|intcomma }}</td>

<td class="{% if s.success_rate < 50 %}low{% elif s.success_rate < 80 %}mid{% else %}high{% endif %}">
{{ s.success_rate }}%
</td>
</tr>

{% for d in ar_detail %}
{% if d.unit_kerja == s.unit_kerja %}
<tr class="{{ s.unit_kerja }}" style="display:none">
<td>&nbsp;&nbsp;&nbsp;→ {{ d.petugas_pengawasan }}</td>
<td>{{ d.sp2dk }}</td>
<td>{{ d.lhp2dk }}</td>
<td>{{ d.outstanding }}</td>
<td>Rp {{ d.potensi|floatformat:0|intcomma }}</td>
<td>Rp {{ d.realisasi|floatformat:0|intcomma }}</td>
<td></td>
</tr>
{% endif %}
{% endfor %}

{% endfor %}

</tbody>
</table>

</div>
<div class="row text-center">

<div class="col-md-2">
<div class="card shadow-sm p-2">
<b>Total DPP</b>
<h5>{{ total_dpp|intcomma }}</h5>
</div>
</div>

<div class="col-md-2">
<div class="card shadow-sm p-2">
<b>Total LHP2DK</b>
<h5>{{ total_lhp2dk|intcomma }}</h5>
</div>
</div>

<div class="col-md-2">
<div class="card shadow-sm p-2">
<b>Total Outstanding</b>
<h5>{{ total_outstanding|intcomma }}</h5>
</div>
</div>

<div class="col-md-3">
<div class="card shadow-sm p-2">
<b>Total Potensi</b>
<h5>Rp {{ total_potensi|floatformat:0|intcomma }}</h5>
</div>
</div>

<div class="col-md-3">
<div class="card shadow-sm p-2">
<b>Total Realisasi</b>
<h5>Rp {{ total_realisasi|floatformat:0|intcomma }}</h5>
</div>
</div>
</div>

<br>

<nav>
<ul class="pagination justify-content-center">

{% if seksi_summary.has_previous %}
<li class="page-item">
<a class="page-link"
href="?page={{ seksi_summary.previous_page_number }}">
« Prev
</a>
</li>
{% endif %}

{% for num in seksi_summary.paginator.page_range %}
{% if num == seksi_summary.number %}
<li class="page-item active">
<span class="page-link">{{ num }}</span>
</li>
{% else %}
<li class="page-item">
<a class="page-link" href="?page={{ num }}">
{{ num }}
</a>
</li>
{% endif %}
{% endfor %}

{% if seksi_summary.has_next %}
<li class="page-item">
<a class="page-link"
href="?page={{ seksi_summary.next_page_number }}">
Next »
</a>
</li>
{% endif %}

</ul>
</nav>

<br>

<div class="row">
<div class="col-md-6">
<div class="card-box">
<h6 class="text-center">KESIMPULAN LHP2DK</h6>
<canvas id="pie"></canvas>
</div>
</div>

<div class="col-md-6">
<div class="card-box">
<h6 class="text-center">SP2DK TERBIT PER BULAN</h6>
<canvas id="bar"></canvas>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function toggle(cls){
  const rows=document.getElementsByClassName(cls);
  for(let i=0;i<rows.length;i++){
    rows[i].style.display = rows[i].style.display==="none" ? "" : "none";
  }
}

new Chart(document.getElementById("pie"),{
  type:'pie',
  data:{
    labels: {{ pie_labels|safe }},
    datasets:[{
      data: {{ pie_values|safe }}
    }]
  }
});

new Chart(document.getElementById("bar"),{
  type:'bar',
  data:{
    labels: {{ bar_labels|safe }},
    datasets:[{
      data: {{ bar_values|safe }}
    }]
  }
});
</script>

<style>
.low{color:red;font-weight:bold;}
.mid{color:orange;font-weight:bold;}
.high{color:green;font-weight:bold;}

.pagination .page-link{
  border-radius:8px;
  margin:2px;
  color:#0a2d82;
  font-weight:600;
}

.pagination .active .page-link{
  background:#0a2d82;
  color:white;
}
</style>

{% endblock %}
