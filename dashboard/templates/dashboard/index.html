{% extends "dashboard/base.html" %}
{% load humanize %}
{% block content %}

<h4 class="mb-3 fw-bold">Dashboard Ringkasan SP2DK</h4>

<form method="get" class="card-box mb-3">
  <div class="row">

    <div class="col-md-2">
      <label>Tahun Pajak</label>
      <select name="tahun_sp2dk" class="form-control" onchange="this.form.submit()">
        <option value="All">All</option>
        {% for t in tahun_list %}
          <option value="{{ t }}" {% if selected_tahun_sp2dk == t %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label>Seksi</label>
      <select name="seksi" class="form-control" onchange="this.form.submit()">
        <option value="All">All</option>
        {% for s in seksi_list %}
          <option value="{{ s }}" {% if selected_seksi == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label>AR</label>
      <select name="ar" class="form-control" onchange="this.form.submit()">
        <option value="All">All</option>
        {% for a in ar_list %}
          <option value="{{ a }}" {% if selected_ar == a %}selected{% endif %}>{{ a }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label>Kesimpulan</label>
      <select name="kesimpulan" class="form-control" onchange="this.form.submit()">
        <option value="All">All</option>
        {% for k in pie_labels %}
          <option value="{{ k }}" {% if selected_kesimpulan == k %}selected{% endif %}>{{ k }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label>Semester</label>
      <select name="semester" class="form-control" onchange="this.form.submit()">
        <option value="All" {% if selected_semester == "All" %}selected{% endif %}>All</option>
        <option value="1" {% if selected_semester == "1" %}selected{% endif %}>Semester 1</option>
        <option value="2" {% if selected_semester == "2" %}selected{% endif %}>Semester 2</option>
      </select>
    </div>

  </div>
</form>

<div class="card-box">
<table class="table table-bordered">

<thead class="table-header">
<tr>
  <th rowspan="2">Unit / AR</th>
  <th rowspan="2">Jumlah DPP</th>

  <th colspan="4">LHPT</th>
  <th colspan="4">SP2DK</th>

  <th rowspan="2">Potensi Awal</th>
  <th rowspan="2">Potensi Akhir</th>
  <th rowspan="2">Realisasi</th>
  <th rowspan="2">Success Rate</th>
</tr>
<tr>
  <th>Sudah SP2DK</th>
  <th>%</th>
  <th>Tanpa SP2DK</th>
  <th>%</th>

  <th>Sudah LHP2DK</th>
  <th>%</th>
  <th>Belum LHP2DK</th>
  <th>%</th>
</tr>
</thead>

<tbody>

{% for s in seksi_summary %}
<tr style="background:#eef3ff;font-weight:bold">
  <td onclick="toggle('{{ s.unit_key }}')" style="cursor:pointer">
    + {{ s.unit_kerja }}
  </td>

  <td class="text-center">{{ s.dpp }}</td>

  <td class="text-center">{{ s.lhpt_sudah_sp2dk }}</td>
  <td class="text-center">{{ s.lhpt_sudah_pct }}%</td>
  <td class="text-center">{{ s.lhpt_belum_sp2dk }}</td>
  <td class="text-center">{{ s.lhpt_belum_pct }}%</td>


  <td class="text-center">{{ s.sp2dk_sudah_lhp2dk }}</td>
  <td class="text-center">{{ s.sp2dk_sudah_pct }}%</td>
  <td class="text-center">{{ s.sp2dk_belum_lhp2dk }}</td>
  <td class="text-center">{{ s.sp2dk_belum_pct }}%</td>

  <td class="text-end">Rp {{ s.potensi_awal|floatformat:0|intcomma }}</td>
  <td class="text-end">Rp {{ s.potensi_akhir|floatformat:0|intcomma }}</td>
  <td class="text-end">Rp {{ s.realisasi|floatformat:0|intcomma }}</td>

  <td class="{% if s.success_rate < 50 %}low{% elif s.success_rate < 80 %}mid{% else %}high{% endif %} text-center">
    {{ s.success_rate }}%
  </td>
</tr>

{% for d in ar_detail %}
{% if d.unit_key == s.unit_key %}
<tr class="{{ s.unit_key }}" style="display:none">
  <td>&nbsp;&nbsp;&nbsp;â†’ {{ d.petugas_pengawasan }}</td>

  <td class="text-center">{{ d.dpp }}</td>

  <td class="text-center">{{ d.lhpt_sudah_sp2dk }}</td>
  <td class="text-center">{{ d.lhpt_pct }}%</td>
  <td class="text-center">{{ d.lhpt_belum_sp2dk }}</td>
  <td class="text-center">{{ d.lhpt_belum_pct }}%</td>

  <td class="text-center">{{ d.sp2dk_sudah_lhp2dk }}</td>
  <td class="text-center">{{ d.sp2dk_pct }}%</td>
  <td class="text-center">{{ d.sp2dk_belum_lhp2dk }}</td>
  <td class="text-center">{{ d.sp2dk_belum_pct }}%</td>

  <td class="text-end">Rp {{ d.potensi_awal|floatformat:0|intcomma }}</td>
  <td class="text-end">Rp {{ d.potensi_akhir|floatformat:0|intcomma }}</td>
  <td class="text-end">Rp {{ d.realisasi|floatformat:0|intcomma }}</td>

  <td class="{% if d.success_rate < 50 %}low{% elif d.success_rate < 80 %}mid{% else %}high{% endif %}">
    {{ d.success_rate }}%
  </td>
</tr>
{% endif %}
{% endfor %}

{% endfor %}

</tbody>
</table>
</div>

<br>

<div class="row text-center">
  <div class="col-md-2"><div class="card p-2"><b>Total DPP</b><h5>{{ total_dpp|intcomma }}</h5></div></div>
  <div class="col-md-2"><div class="card p-2"><b>Total LHP2DK</b><h5>{{ total_lhp2dk|intcomma }}</h5></div></div>
  <div class="col-md-2"><div class="card p-2"><b>Total Outstanding</b><h5>{{ total_outstanding|floatformat:0 }}</h5></div></div>
  <div class="col-md-2"><div class="card p-2"><b>Total Potensi Awal</b><h5>Rp {{ total_potensi_awal|floatformat:0|intcomma }}</h5></div></div>
  <div class="col-md-2"><div class="card p-2"><b>Total Potensi Akhir</b><h5>Rp {{ total_potensi_akhir|floatformat:0|intcomma }}</h5></div></div>
  <div class="col-md-2"><div class="card p-2"><b>Total Realisasi</b><h5>Rp {{ total_realisasi|floatformat:0|intcomma }}</h5></div></div>
</div>

<br><br>

<div class="row">

<div class="col-md-6">
<div class="card-box">
<h6 class="text-center">KESIMPULAN LHP2DK</h6>
<canvas id="pie"></canvas>
</div>
</div>

<div class="col-md-6">
<div class="card-box">
<h6 class="text-center">SP2DK TERBIT PER BULAN</h6>
<canvas id="bar"></canvas>
</div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

Chart.defaults.font.size = 11;
Chart.defaults.font.family = 'Inter';

function toggle(cls){
  const rows=document.getElementsByClassName(cls);
  for(let i=0;i<rows.length;i++){
    rows[i].style.display = rows[i].style.display==="none" ? "" : "none";
  }
}

new Chart(document.getElementById("pie"),{
  type:'pie',
  data:{
    labels: {{ pie_labels|safe }},
    datasets:[{
      data: {{ pie_values|safe }}
    }]
  }
});

new Chart(document.getElementById("bar"),{
  type:'bar',
  data:{
    labels: {{ bar_labels|safe }},
    datasets:[{
      label: "Jumlah SP2DK",
      data: {{ bar_values|safe }},
      backgroundColor: 'rgba(13, 71, 161, 0.8)'
    }]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false
  }
});
</script>

<style>

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

body{
    font-family:'Inter',sans-serif;
    font-size:13px;
    color:#1f2937;
}

.table{
    font-size:12px;
}

.table td,.table th{
    padding:6px 8px!important;
    vertical-align:middle;
}

.table-header{
    background:#ecf2ff;
    font-size:11px;
    letter-spacing:.4px;
    text-transform:uppercase;
}

.card-box{
    background:white;
    border-radius:16px;
    padding:14px 18px;
    box-shadow:0 8px 22px rgba(0,0,0,.05);
}

.card{
    border-radius:18px;
    font-size:12px;
}

.card h5{
    font-size:14px;
}

.low{color:#dc2626;font-weight:700;}
.mid{color:#ea580c;font-weight:700;}
.high{color:#16a34a;font-weight:700;}

td[onclick]{
    color:#0a2d82;
    font-weight:600;
}

form select{
    font-size:12px;
    border-radius:10px;
}

h6{
    font-weight:600;
    font-size:13px;
    letter-spacing:.3px;
}
#bar{
    min-height:280px;
}
#bar{
    max-height:300px;
    height:300px;
}
</style>

{% endblock %}
