{% extends "dashboard/base.html" %}
{% load humanize static %}
{% block content %}

<h4 class="mb-3 fw-bold">SP2DK – Tahun Berhalan</h4>

<form method="get" class="card-box mb-3">

<div class="row">

<div class="col-md-3">
<label>Tahun Pajak</label>
<select name="tahun" class="form-control" onchange="this.form.submit()">
<option value="All">All</option>
{% for t in tahun_list %}
<option value="{{ t }}" {% if selected_tahun == t|stringformat:"s" %}selected{% endif %}>{{ t }}</option>
{% endfor %}
</select>
</div>

<div class="col-md-3">
<label>AR</label>
<select name="ar" class="form-control" onchange="this.form.submit()">
<option value="All">All</option>
{% for a in ar_list %}
<option value="{{ a }}" {% if selected_ar == a %}selected{% endif %}>{{ a }}</option>
{% endfor %}
</select>
</div>

<div class="col-md-3">
<label>Kesimpulan</label>
<select name="kesimpulan" class="form-control" onchange="this.form.submit()">
<option value="All">All</option>
<option value="Selesai" {% if selected_kesimpulan == 'Selesai' %}selected{% endif %}>Selesai</option>
<option value="Dalam Pengawasan" {% if selected_kesimpulan == 'Dalam Pengawasan' %}selected{% endif %}>Dalam Pengawasan</option>
<option value="Usul Pemeriksaan" {% if selected_kesimpulan == 'Usul Pemeriksaan' %}selected{% endif %}>Usul Pemeriksaan</option>
</select>
</div>

<div class="col-md-3">
<label>Minimal Hari</label>
<input type="number"
       name="min_hari"
       class="form-control"
       value="{{ min_hari }}"
       placeholder="contoh: 30"
       onchange="this.form.submit()">
</div>

<div class="col-md-3">
<label>Maksimal Hari</label>
<input type="number"
       name="max_hari"
       class="form-control"
       value="{{ max_hari }}"
       placeholder="contoh: 90"
       onchange="this.form.submit()">
</div>

<div class="col-md-3">
<label>Status</label>
<select name="status" class="form-control" onchange="this.form.submit()">
<option value="All" {% if selected_status == 'All' %}selected{% endif %}>All</option>
<option value="Closed" {% if selected_status == 'Closed' %}selected{% endif %}>Closed</option>
<option value="Open" {% if selected_status == 'Open' %}selected{% endif %}>Open</option>
</select>
</div>

</div>
</form>

<div class="card-box">
<div class="table-wrapper">
<table class="table table-bordered table-sm">
<thead class="table-header">
<tr>
<th>NIP AR</th>
<th>Nama AR</th>
<th>NPWP</th>
<th>Nama WP</th>
<th>Nomor SP2DK</th>
<th>Tanggal SP2DK</th>
<th>Tahun Pajak</th>
<th>Estimasi Potensi SP2DK</th>
<th>Nomor LHP2DK</th>
<th>Tanggal LHP2DK</th>
<th>Kesimpulan</th>
<th>Estimasi Potensi LHP2DK</th>
<th>Realisasi</th>
<th>Hari</th>
<th>Status</th>
<th>Waktu Closed (Hari)</th>
</tr>
</thead>

<tbody>

{% for d in data %}
<tr>
<td>{{ d.nip_ar }}</td>
<td>{{ d.nama_ar }}</td>
<td>{{ d.npwp }}</td>
<td>{{ d.nama_wp }}</td>
<td>{{ d.nomor_sp2dk }}</td>
<td>{{ d.tanggal_sp2dk }}</td>
<td>{{ d.tahun_sp2dk }}</td>
<td>Rp {{ d.estimasi_potensi_sp2dk|default:0|floatformat:0|intcomma }}</td>
<td>{{ d.nomor_lhp2dk|default:"-" }}</td>
<td>{{ d.tanggal_lhp2dk|date:"d-m-Y" }}</td>
<td>
<span class="badge bg-info text-dark">{{ d.kesimpulan }}</span>
</td>
<td>Rp {{ d.estimasi_potensi_lhp2dk|default:0|floatformat:0|intcomma }}</td>
<td>Rp {{ d.realisasi|default:0|floatformat:0|intcomma }}</td>
<td>{{ d.hari|floatformat:0 }}</td>
<td>
    {% if d.status == "Closed" %}
        <span class="badge bg-success">Closed</span>
    {% else %}
        <span class="badge bg-danger">Open</span>
    {% endif %}
</td>

<td>
    {% if d.status == "Closed" %}
        {{ d.waktu_closed|default:"-" }}
    {% else %}
        -
    {% endif %}
</td>
</tr>

{% empty %}
<tr>
<td colspan="13" class="text-center text-muted">Tidak ada data</td>
</tr>
{% endfor %}

</tbody>
</table>
</div>
</div>

<div class="row mt-3">

<div class="col-md-6">
<div class="card p-3 shadow-sm">
<b>Total Potensi</b>
<h5>Rp {{ total_potensi|floatformat:0|intcomma }}</h5>
</div>
</div>

<div class="col-md-6">
<div class="card p-3 shadow-sm">
<b>Total Realisasi</b>
<h5>Rp {{ total_realisasi|floatformat:0|intcomma }}</h5>
</div>
</div>

</div>

<nav class="mt-3">
<ul class="pagination justify-content-center">

{% if data.has_previous %}
<li class="page-item">
<a class="page-link" href="?page={{ data.previous_page_number }}&tahun={{ selected_tahun }}&ar={{ selected_ar }}&kesimpulan={{ selected_kesimpulan }}">« Prev</a>
</li>
{% else %}
<li class="page-item disabled"><span class="page-link">« Prev</span></li>
{% endif %}

{% for num in data.paginator.page_range %}
{% if num == data.number %}
<li class="page-item active"><span class="page-link">{{ num }}</span></li>
{% elif num >= data.number|add:"-2" and num <= data.number|add:"2" %}
<li class="page-item">
<a class="page-link" href="?page={{ num }}&tahun={{ selected_tahun }}&ar={{ selected_ar }}&kesimpulan={{ selected_kesimpulan }}">{{ num }}</a>
</li>
{% endif %}
{% endfor %}

{% if data.has_next %}
<li class="page-item">
<a class="page-link" href="?page={{ data.next_page_number }}&tahun={{ selected_tahun }}&ar={{ selected_ar }}&kesimpulan={{ selected_kesimpulan }}">Next »</a>
</li>
{% else %}
<li class="page-item disabled"><span class="page-link">Next »</span></li>
{% endif %}

</ul>
</nav>

<style>

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

body{
    font-family:'Inter',sans-serif;
    font-size:13px;
}

.table{
    font-size:12px;
}

.table td,.table th{
    padding:6px 8px!important;
    vertical-align:middle;
}

.table-wrapper{
    overflow-x: auto;
    white-space: nowrap;
    width: 100%;
}

.table-header{
    background:#eef3ff;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.3px;
}

.card-box{
    background:white;
    border-radius:16px;
    padding:14px 18px;
    box-shadow:0 8px 22px rgba(0,0,0,.05);
}

.pagination .page-item .page-link{
    border-radius:8px;
    margin:2px;
    color:#0a2d82;
    font-weight:600;
    border:1px solid #dcdcdc;
    min-width:34px;
}

.pagination .active .page-link{
    background:#0a2d82;
    border-color:#0a2d82;
    color:white;
}

.badge{
    font-size:11px;
    padding:6px 8px;
}

</style>

{% endblock %}